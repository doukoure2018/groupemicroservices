# Guidipress - Production Docker Compose
# Domain: guidipress-io.com

services:
  # ==============================================
  # DATABASE SERVICES
  # ==============================================
  postgresdb:
    container_name: billetterie-postgres
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGPORT: 5433
    expose:
      - 5433
    ports:
      - "5433:5433"
    volumes:
      - billetterie_postgres_data:/var/lib/postgresql/data
    networks:
      - billetterie-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} -p 5433" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # Database Migration Service
  flyway-migrations:
    image: flyway/flyway:11.3.0
    container_name: billetterie-flyway
    environment:
      FLYWAY_URL: "jdbc:postgresql://postgresdb:5433/${POSTGRES_DB}"
      FLYWAY_USER: ${POSTGRES_USER}
      FLYWAY_PASSWORD: ${POSTGRES_PASSWORD}
      FLYWAY_SCHEMAS: public
      FLYWAY_TABLE: flyway_schema_history
      FLYWAY_BASELINE_ON_MIGRATE: "true"
      FLYWAY_VALIDATE_ON_MIGRATE: "true"
      FLYWAY_OUT_OF_ORDER: "false"
      FLYWAY_CLEAN_DISABLED: "true"
      FLYWAY_BASELINE_VERSION: "1"
    volumes:
      - ./microservers/database-migrations/src/main/resources/db/migration:/flyway/sql
    command: migrate
    networks:
      - billetterie-network
    depends_on:
      postgresdb:
        condition: service_healthy
    restart: "no"
    profiles:
      - migration
      - full

  pgadmin:
    container_name: billetterie-pgadmin
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_LISTEN_PORT: 7001
    depends_on:
      - postgresdb
    ports:
      - "7001:7001"
    volumes:
      - billetterie_pgadmin:/var/lib/pgadmin
    networks:
      - billetterie-network
    profiles:
      - tools

  # ==============================================
  # MESSAGING SERVICES
  # ==============================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: billetterie-zookeeper
    ports:
      - "2183:2183"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2183
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - billetterie-network
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: billetterie-kafka
    ports:
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2183
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9093,PLAINTEXT_INTERNAL://kafka:29093
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9093,PLAINTEXT_INTERNAL://0.0.0.0:29093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper
    networks:
      - billetterie-network
    restart: unless-stopped

  # ==============================================
  # MICROSERVICES
  # ==============================================
  discoveryserver:
    image: doukoure93/billetterie-discoveryserver:latest
    container_name: billetterie-discoveryserver
    ports:
      - "8761:8761"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresdb:5433/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      EUREKA_USER: ${EUREKA_USER:-manager}
      EUREKA_PASSWORD: ${EUREKA_PASSWORD:-manager2711}
    volumes:
      - ./logs/discoveryserver:/var/log/discoveryserver
    networks:
      - billetterie-network
    depends_on:
      postgresdb:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8761/actuator/health || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  gateway:
    image: doukoure93/billetterie-gateway:latest
    container_name: billetterie-gateway
    ports:
      - "9000:9000"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      EUREKA_USER: ${EUREKA_USER:-manager}
      EUREKA_PASSWORD: ${EUREKA_PASSWORD:-manager2711}
      JWKS_URI: http://authorizationserver:8090/authorization/oauth2/jwks
    volumes:
      - ./logs/gateway:/var/log/gateway
    networks:
      - billetterie-network
    depends_on:
      discoveryserver:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  authorizationserver:
    image: doukoure93/billetterie-authorizationserver:latest
    container_name: billetterie-authorizationserver
    ports:
      - "8090:8090"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresdb:5433/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      EUREKA_USER: ${EUREKA_USER:-manager}
      EUREKA_PASSWORD: ${EUREKA_PASSWORD:-manager2711}
      UI_APP_URL: ${UI_APP_URL}
      OAUTH_ISSUER: ${OAUTH_ISSUER}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-true}
      SERVER_FORWARD_HEADERS_STRATEGY: NATIVE
    volumes:
      - ./keys:/app/keys
      - ./logs/authorizationserver:/var/log/authorizationserver
    networks:
      - billetterie-network
    depends_on:
      postgresdb:
        condition: service_healthy
      discoveryserver:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8090/authorization/actuator/health || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  userservice:
    image: doukoure93/billetterie-userservice:latest
    container_name: billetterie-userservice
    ports:
      - "8091:8091"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresdb:5433/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      EUREKA_USER: ${EUREKA_USER:-manager}
      EUREKA_PASSWORD: ${EUREKA_PASSWORD:-manager2711}
      JWKS_URI: http://authorizationserver:8090/authorization/oauth2/jwks
      KAFKA_BOOTSTRAP_SERVERS: kafka:29093
      UI_APP_URL: ${UI_APP_URL}
      ORANGE_API_CREDENTIALS: ${ORANGE_API_CREDENTIALS}
      ORANGE_SENDER_ADDRESS: ${ORANGE_SENDER_ADDRESS}
    volumes:
      - ./keys:/app/keys
      - ./logs/userservice:/var/log/userservice
    networks:
      - billetterie-network
    depends_on:
      postgresdb:
        condition: service_healthy
      kafka:
        condition: service_started
      discoveryserver:
        condition: service_healthy
      authorizationserver:
        condition: service_started
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8091/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  billetterieservice:
    image: doukoure93/billetterie-billetterieservice:latest
    container_name: billetterie-billetterieservice
    ports:
      - "8092:8092"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresdb:5433/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      EUREKA_USER: ${EUREKA_USER:-manager}
      EUREKA_PASSWORD: ${EUREKA_PASSWORD:-manager2711}
      JWKS_URI: http://authorizationserver:8090/authorization/oauth2/jwks
      KAFKA_BOOTSTRAP_SERVERS: kafka:29093
      UI_APP_URL: ${UI_APP_URL}
    volumes:
      - ./keys:/app/keys
      - ./logs/billetterieservice:/var/log/billetterieservice
    networks:
      - billetterie-network
    depends_on:
      postgresdb:
        condition: service_healthy
      kafka:
        condition: service_started
      discoveryserver:
        condition: service_healthy
      authorizationserver:
        condition: service_started
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8092/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  notificationserver:
    image: doukoure93/billetterie-notificationserver:latest
    container_name: billetterie-notificationserver
    ports:
      - "8093:8093"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresdb:5433/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      EUREKA_USER: ${EUREKA_USER:-manager}
      EUREKA_PASSWORD: ${EUREKA_PASSWORD:-manager2711}
      JWKS_URI: http://authorizationserver:8090/authorization/oauth2/jwks
      KAFKA_BOOTSTRAP_SERVERS: kafka:29093
      GMAIL_USERNAME: ${GMAIL_USERNAME}
      GMAIL_APP_PASSWORD: ${GMAIL_APP_PASSWORD}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Guidipress}
      UI_APP_URL: ${UI_APP_URL}
    volumes:
      - ./keys:/app/keys
      - ./logs/notificationserver:/var/log/notificationserver
    networks:
      - billetterie-network
    depends_on:
      postgresdb:
        condition: service_healthy
      kafka:
        condition: service_started
      discoveryserver:
        condition: service_healthy
      authorizationserver:
        condition: service_started
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8093/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # ==============================================
  # FRONTEND
  # ==============================================
  frontend:
    image: doukoure93/billetterie-frontend:latest
    container_name: billetterie-frontend
    ports:
      - "4202:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - billetterie-network
    depends_on:
      - gateway
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ==============================================
# VOLUMES
# ==============================================
volumes:
  billetterie_postgres_data:
  billetterie_pgadmin:

# ==============================================
# NETWORKS
# ==============================================
networks:
  billetterie-network:
    driver: bridge
