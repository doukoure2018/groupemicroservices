name: CD - Deploy Frontend to OVH

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - frontend/**

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

      - name: Generate build tag
        id: build-number
        run: echo "BUILD_NUMBER=$(date '+%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Build and push frontend image
        run: |
          cd frontend/ultima-ng-19.0.0

          # Build with production URLs
          docker build \
            -t doukoure93/billetterie-frontend:${{ steps.build-number.outputs.BUILD_NUMBER }} \
            -t doukoure93/billetterie-frontend:latest \
            --build-arg API_BASE_URL=https://api.guidipress-io.com \
            --build-arg AUTH_SERVER_URL=https://api.guidipress-io.com/authorization \
            --file Dockerfile \
            .

          # Push images
          docker push doukoure93/billetterie-frontend:${{ steps.build-number.outputs.BUILD_NUMBER }}
          docker push doukoure93/billetterie-frontend:latest

      - name: Deploy frontend to OVH server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd ~/billetterie

            # Remove old frontend container
            sudo docker rm -f billetterie-frontend || true

            # Pull new image
            sudo docker compose --env-file .env.prod pull frontend

            # Start frontend
            sudo docker compose --env-file .env.prod up -d frontend

            # Show status
            sudo docker compose --env-file .env.prod ps
            sleep 5
            sudo docker compose --env-file .env.prod logs --tail=30 frontend

      - name: Verify deployment health
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            max_attempts=30
            attempt=0

            echo "Testing frontend availability..."
            while [ $attempt -lt $max_attempts ]; do
              if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:4202 | grep -q "200"; then
                echo "Frontend is responding correctly"
                break
              else
                echo "Waiting for frontend... ($attempt/$max_attempts)"
                sleep 2
                attempt=$((attempt + 1))
              fi
            done

            if [ $attempt -eq $max_attempts ]; then
              echo "Frontend health check failed"
              sudo docker logs billetterie-frontend --tail=50
              exit 1
            fi
