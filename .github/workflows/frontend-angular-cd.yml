name: CD - Deploy Frontend to OVH

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - frontend/**

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify deployment start
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":":angular: Guidipress Frontend deployment started\nCommit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }} || true

      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

      - name: Generate build tag
        id: build-number
        run: echo "BUILD_NUMBER=$(date '+%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Build and push frontend image
        run: |
          cd frontend/ultima-ng-19.0.0

          # Build with production URLs
          docker build \
            -t doukoure93/billetterie-frontend:${{ steps.build-number.outputs.BUILD_NUMBER }} \
            -t doukoure93/billetterie-frontend:latest \
            --build-arg API_BASE_URL=https://api.guidipress-io.com \
            --build-arg AUTH_SERVER_URL=https://api.guidipress-io.com/authorization \
            --build-arg FRONTEND_URL=https://guidipress-io.com \
            --file Dockerfile \
            .

          # Push images
          docker push doukoure93/billetterie-frontend:${{ steps.build-number.outputs.BUILD_NUMBER }}
          docker push doukoure93/billetterie-frontend:latest

      - name: Notify image pushed
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":":whale: Guidipress Frontend image pushed!\nTag: ${{ steps.build-number.outputs.BUILD_NUMBER }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }} || true

      - name: Deploy frontend to OVH server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            # Remove old frontend container
            sudo docker rm -f billetterie-frontend || true

            # Ensure network exists
            sudo docker network create billetterie-network 2>/dev/null || true

            # Pull new image
            sudo docker pull doukoure93/billetterie-frontend:latest

            # Start frontend container
            sudo docker run -d \
              --name billetterie-frontend \
              --network billetterie-network \
              -p 4202:80 \
              --restart unless-stopped \
              --memory 256m \
              doukoure93/billetterie-frontend:latest

            sleep 5

            # Check if container is running
            if sudo docker ps | grep -q billetterie-frontend; then
              echo "Container is running"
              sudo docker logs billetterie-frontend --tail=30
            else
              echo "Container failed to start!"
              sudo docker logs billetterie-frontend --tail=50
              exit 1
            fi

      - name: Verify deployment health
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            max_attempts=30
            attempt=0

            echo "Testing frontend availability..."
            while [ $attempt -lt $max_attempts ]; do
              if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:4202 | grep -q "200"; then
                echo "Frontend is responding correctly"
                break
              else
                echo "Waiting for frontend... ($attempt/$max_attempts)"
                sleep 2
                attempt=$((attempt + 1))
              fi
            done

            if [ $attempt -eq $max_attempts ]; then
              echo "Frontend health check failed"
              sudo docker logs billetterie-frontend --tail=50
              exit 1
            fi

      - name: Notify deployment success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":":white_check_mark: Guidipress Frontend deployed!\n:globe_with_meridians: https://guidipress-io.com\n:package: Version: ${{ steps.build-number.outputs.BUILD_NUMBER }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }} || true

      - name: Notify deployment failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":":rotating_light: Guidipress Frontend deployment FAILED!\n:link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }} || true
