<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="utilisateurs-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>Gestion des Utilisateurs</h1>
            <p class="subtitle">Consultez et gérez les rôles des utilisateurs du système</p>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid">
        <p-card styleClass="stat-card">
            <div class="stat-content">
                <div class="stat-icon total">
                    <i class="pi pi-users"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ totalUsers() }}</span>
                    <span class="stat-label">Total Utilisateurs</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="stat-card">
            <div class="stat-content">
                <div class="stat-icon active">
                    <i class="pi pi-check-circle"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ activeUsers() }}</span>
                    <span class="stat-label">Actifs</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="stat-card">
            <div class="stat-content">
                <div class="stat-icon controleur">
                    <i class="pi pi-id-card"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ controleurs() }}</span>
                    <span class="stat-label">Contrôleurs</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="stat-card">
            <div class="stat-content">
                <div class="stat-icon admin">
                    <i class="pi pi-shield"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ admins() }}</span>
                    <span class="stat-label">Admins</span>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Barre de recherche -->
    <div class="toolbar">
        <p-iconField iconPosition="left" class="search-field">
            <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
            <input type="text" pInputText placeholder="Rechercher par nom, email, username ou rôle..."
                [value]="searchTerm()" (input)="onSearchChange($event)" />
        </p-iconField>

        <p-button icon="pi pi-refresh" [outlined]="true" [loading]="loading()" (onClick)="loadUsers()"
            pTooltip="Actualiser" tooltipPosition="top">
        </p-button>
    </div>

    <!-- Table des utilisateurs -->
    <p-card>
        @if (loading()) {
        <div class="loading-container">
            <p-progressSpinner strokeWidth="4" ariaLabel="Chargement"></p-progressSpinner>
            <span>Chargement des utilisateurs...</span>
        </div>
        } @else {
        <p-table [value]="filteredUsers()" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5, 10, 25, 50]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} utilisateurs"
            [tableStyle]="{ 'min-width': '80rem' }" styleClass="p-datatable-sm p-datatable-striped">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="firstName" style="width: 200px">
                        Nom <p-sortIcon field="firstName"></p-sortIcon>
                    </th>
                    <th pSortableColumn="email">
                        Email <p-sortIcon field="email"></p-sortIcon>
                    </th>
                    <th pSortableColumn="username">
                        Username <p-sortIcon field="username"></p-sortIcon>
                    </th>
                    <th pSortableColumn="phone">
                        Téléphone <p-sortIcon field="phone"></p-sortIcon>
                    </th>
                    <th pSortableColumn="role" style="width: 140px">
                        Rôle <p-sortIcon field="role"></p-sortIcon>
                    </th>
                    <th pSortableColumn="enabled" style="width: 100px">
                        Statut <p-sortIcon field="enabled"></p-sortIcon>
                    </th>
                    <th pSortableColumn="lastLogin">
                        Dernière connexion <p-sortIcon field="lastLogin"></p-sortIcon>
                    </th>
                    <th style="width: 100px">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-user>
                <tr [class.inactive-row]="!user.enabled">
                    <td>
                        <div class="user-name">
                            <i class="pi pi-user"></i>
                            <span>{{ user.firstName }} {{ user.lastName }}</span>
                        </div>
                    </td>
                    <td>
                        <span class="email-text">{{ user.email }}</span>
                    </td>
                    <td>
                        <span class="username-badge">{{ user.username }}</span>
                    </td>
                    <td>{{ user.phone || '-' }}</td>
                    <td>
                        <p-tag [value]="user.role" [severity]="getRoleSeverity(user.role)"></p-tag>
                    </td>
                    <td>
                        <p-tag [value]="user.enabled ? 'Actif' : 'Inactif'"
                            [severity]="getStatusSeverity(user.enabled)"></p-tag>
                    </td>
                    <td>{{ user.lastLogin ? (user.lastLogin | date:'dd/MM/yyyy HH:mm') : 'Jamais' }}</td>
                    <td>
                        <div class="actions-cell">
                            <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info"
                                (onClick)="openRoleDialog(user)" pTooltip="Modifier le rôle" tooltipPosition="top">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <i class="pi pi-inbox"></i>
                            <p>Aucun utilisateur trouvé</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
        }
    </p-card>
</div>

<!-- Dialog Modifier Rôle -->
<p-dialog header="Modifier le rôle" [(visible)]="roleDialogVisible" [modal]="true" [style]="{ width: '450px' }"
    [draggable]="false" [resizable]="false" (onHide)="closeRoleDialog()">

    @if (selectedUser()) {
    <div class="role-dialog-content">
        <div class="user-info-card">
            <div class="user-avatar">
                <i class="pi pi-user"></i>
            </div>
            <div class="user-details">
                <span class="user-fullname">{{ selectedUser()!.firstName }} {{ selectedUser()!.lastName }}</span>
                <span class="user-email">{{ selectedUser()!.email }}</span>
            </div>
        </div>

        <div class="role-current">
            <label>Rôle actuel</label>
            <p-tag [value]="selectedUser()!.role" [severity]="getRoleSeverity(selectedUser()!.role)"></p-tag>
        </div>

        <div class="form-field">
            <label for="newRole">Nouveau rôle</label>
            <p-select id="newRole" [options]="roles()" [(ngModel)]="newRole" optionLabel="name" optionValue="name"
                placeholder="Sélectionner un rôle" [appendTo]="'body'" fluid>
            </p-select>
        </div>
    </div>

    <div class="dialog-footer">
        <p-button label="Annuler" [outlined]="true" severity="secondary" (onClick)="closeRoleDialog()">
        </p-button>
        <p-button label="Modifier" (onClick)="confirmUpdateRole()" [loading]="loading()" icon="pi pi-check"
            [disabled]="!newRole || newRole === selectedUser()!.role">
        </p-button>
    </div>
    }
</p-dialog>